name: Validate metadata JSON

on:
  pull_request:
    paths:
      - 'meta-data.json'
      - '.github/**'

jobs:
  validate-meta:
    name: Validate meta-data.json
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Validate meta-data.json is valid JSON
        run: |
          if [ ! -f meta-data.json ]; then
            echo "meta-data.json not found";
            exit 1;
          fi
          python -m json.tool meta-data.json
          echo "meta-data.json parsed successfully"

      - name: Install jsonschema
        run: |
          python -m pip install --upgrade pip
          pip install jsonschema

      - name: Validate meta-data.json against JSON Schema
        run: |
          python - << 'PY'
          import json, sys
          from jsonschema import Draft7Validator
          
          with open('.github/meta-schema.json','r',encoding='utf-8') as f:
              schema = json.load(f)
          
          with open('meta-data.json','r',encoding='utf-8') as f:
              data = json.load(f)
          
          validator = Draft7Validator(schema)
          errors = list(validator.iter_errors(data))
          if errors:
              print('meta-data.json failed schema validation:')
              for e in errors:
                  # print concise location and message
                  path = '.'.join(str(p) for p in e.path) if e.path else '<root>'
                  print(f'- {path}: {e.message}')
              sys.exit(1)
          print('meta-data.json conforms to schema')
          PY
